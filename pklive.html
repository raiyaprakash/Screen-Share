
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Live Screen</title>

<!-- Mukta Font -->
<link href="https://fonts.googleapis.com/css2?family=Mukta:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family: 'Mukta', sans-serif;
}

body{
    background: linear-gradient(135deg,#0f172a,#1e293b);
    color:#fff;
}

/* Header */
.topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:15px 30px;
    background:#0f172a;
    box-shadow:0 2px 10px rgba(0,0,0,0.4);
}

.logo{
    font-size:20px;
    font-weight:700;
    color:#38bdf8;
}

.new-session-btn{
    background:#22c55e;
    padding:8px 18px;
    border-radius:6px;
    color:#fff;
    text-decoration:none;
    font-weight:600;
    transition:.3s;
}
.new-session-btn:hover{
    background:#16a34a;
}

/* Hero Section */
#hero{
    text-align:center;
    margin-top:50px;
}

#hero h1{
    font-size:32px;
    margin-bottom:20px;
    color:#38bdf8;
}

button{
    padding:12px 20px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
    transition:.3s;
}

#share-button{
    background:#3b82f6;
    color:#fff;
}
#share-button:hover{
    background:#2563eb;
}

#join-meeting-button{
    background:#673AB7;
    color:#fff;
}
#join-meeting-button:hover{
    background:#451994;
}

input{
    padding:10px;
    border-radius:6px;
    border:none;
    width:200px;
    margin-right:8px;background: #111;
    border: 1px solid #5e5e5e;color:#fff;
}

/* Video */
video{
    width:90%;
    max-width:1100px;
    margin-top:30px;
    border-radius:12px;
    box-shadow:0 0 25px rgba(0,0,0,0.6);
}

/* Meeting Controls */
.wrap{
    margin-top:15px;
}

.btn{
    background:#334155;
    color:#fff;
    margin:5px;
}

.btn:hover{
    background:#475569;
}

.hidden{
    display:none;
}

.meetinginfo{
    margin:10px;
    font-size:14px;
    color:#cbd5e1;
}

/* Footer Section */
#landing{
    text-align:center;
    margin:20px 5px;
    opacity:0.8;
}
  
img {
    max-width: 100%;
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-height: 100%;
}
</style>
</head>

<body>

<!-- Top Bar -->
<div class="topbar">
    <div class="logo">
        <i class="fa-solid fa-circle-play"></i> Live
    </div>
    <a href="/" class="new-session-btn">
        <i class="fa-solid fa-plus"></i> New Screen
    </a>
</div>

<!-- Hero Section -->
<div id="hero">

    <button id="share-button">
        <i class="fa-solid fa-share-from-square"></i> Share my screen now
    </button>

    <br><br>
    <div>OR</div>
    <br>

    <input type="number" id="meeting-id" placeholder="Enter share code">
    <button id="join-meeting-button">
        <i class="fa-solid fa-right-to-bracket"></i> Join Meeting
    </button>
</div>

<!-- Main Content -->
<div style="text-align:center">

<div id="presenterinfo" class="hidden">
    <div class="wrap">
        <button id="btnSwitchScreen" class="btn">
            <i class="fa-solid fa-repeat"></i> Switch Screen
        </button>
        <button id="btnPause" class="btn">
            <i class="fa-solid fa-pause"></i> Pause Sharing
        </button>
        <button id="btnEnd" class="btn" style="background:orangered">
            <i class="fa-solid fa-phone-slash"></i> End Session
        </button>
    </div>
    <div id="meeting-room" class="meetinginfo"></div>
    <div id="meeting-url" class="meetinginfo"></div>
    <div id="attendeeStatus" class="meetinginfo"></div>
</div>

<div id="attendeeinfo" class="hidden">
    <div class="wrap">
        <div id="meeting-room-attendee" class="meetinginfo"></div>
        <button id="btnEndAttendee" class="btn" style="background:orangered">
            <i class="fa-solid fa-phone-slash"></i> End Session
        </button>
    </div>
</div>

<video id="video" controls autoplay playsinline muted></video>

<div id="landing">
    <h2>How to start a screen sharing session</h2>
  <img src="/img/screen-share-steps.jpg" alt="Screen sharing steps" loading="lazy" />
</div>

</div>

<script src="https://cdn.ably.com/lib/ably.min-2.js"></script>
<script>const ably = new Ably.Realtime({ key: 'FZIIwA.DPmHYg:wx2NwzPwsJnugsaa20ditsFiIVtlPVbXUXsW5YBbEAk' });</script>
<script defer>
    'use strict';
    const $ = (id) => document.getElementById(id);
    const localVideo = $('video');

    let peer = '';
    if (!location.hash) {
      const id = Math.floor(10 + Math.random() * 90).toString();
      location.hash = id;
      peer = 'pc1';
    } else {
      peer = 'pc2';
      showMeetingUI();
      // localVideo.setAttribute('poster','./img/loading.gif');
    }
    const room = location.hash.substring(1);

    $('join-meeting-button').addEventListener('click', () => {
      const id = $('meeting-id').value.trim().replace(/\s+/g, '');
      if (id) {
        location.hash = id;
        location.reload();
      }
    });

    // ICE Servers
    let iceServers = {
      iceServers: [
        { urls: [
          'stun:stun.l.google.com:19302',
          'stun:stun1.l.google.com:19302',
          'stun:stun2.l.google.com:19302',
          'stun:stun3.l.google.com:19302',
          'stun:stun4.l.google.com:19302',
          'stun:relay.metered.ca:80'
        ]}
      ]
    };

    if (window.chrome) {
      iceServers = { iceServers: iceServers.iceServers };
    }

    let stream, pc1, pc2;
    const offerOptions = { offerToReceiveAudio: 0, offerToReceiveVideo: 1 };
    const channel = ably.channels.get(room);

    if (peer === 'pc1') {
      channel.subscribe('join', () => initBroadcasting());
      channel.subscribe('readyToReceive', (msg) => startBroadcasting(msg));
    } else if (peer === 'pc2') {
      channel.publish('join', room);
      // Set timeout for invalid meeting code
      const connectionTimeout = setTimeout(() => {
        $('meeting-room-attendee').innerText = $('meeting-room-attendee').innerText + ' is incorrect';
      }, 10000); // 10 seconds timeout
      channel.subscribe('readyToBroadcast', (msg) => {
        clearTimeout(connectionTimeout); // Clear timeout on successful connection
        initReceiving(msg);
      });
    }

    $('share-button').addEventListener('click', start);
    async function start() {
      try {
        stream = await (navigator.mediaDevices.getDisplayMedia?.({ video:true }) || navigator.getDisplayMedia({ video:true }));
        localVideo.srcObject = stream;
        await localVideo.play();
        showMeetingUI();

        // Detect when user ends screen share via Chrome ribbon
        const [screenTrack] = stream.getVideoTracks();
        if (screenTrack) {
          screenTrack.onended = () => {
            hangup();
          };
        }

        // Always start broadcasting fresh when presenter shares again
        if (peer === 'pc1') {
          initBroadcasting();
        }
      } catch (e) {
        alert(`Screen share error: ${e.name}`);
      }
    }

    $('btnSwitchScreen').addEventListener('click', async () => {
      try {
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
        const newStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        const newTrack = newStream.getVideoTracks()[0];

        // Replace the existing video track in PeerConnection
        const sender = pc1?.getSenders().find(s => s.track && s.track.kind === 'video');
        if (sender) {
          await sender.replaceTrack(newTrack);
        }

        stream = newStream;
        localVideo.srcObject = stream;

        // Handle "Stop sharing" from Chrome ribbon
        newTrack.onended = () => hangup();

      } catch (e) {
        alert(`Error sharing screen: ${e.name}`);
      }
    });

    $('btnPause').addEventListener('click', () => {
      if (stream) {
        stream.getVideoTracks().forEach(track => {
        track.enabled = !track.enabled;
        $('btnPause').innerText = track.enabled ? 'Pause sharing' : 'Resume sharing';
        });
      }
    });

    $('btnEnd').addEventListener('click', () => {
      if(!confirm("Do you want to end this session ?"))
        return;
      if (stream) stream.getTracks().forEach(track => track.stop());
      hangup();
    });

    $('btnEndAttendee').addEventListener('click', () => {
      if(!confirm("Do you want to end this session ?"))
        return;
      hangup();
    });

    // Switch to compact UI
    function showMeetingUI() {
      $('landing').classList.add('hidden');
      $('hero').classList.add('hidden');
      if (peer === 'pc1')
      {
        $('presenterinfo').classList.remove('hidden');
        $('meeting-room').innerText = 'Share code: ' + room.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        // $('meeting-url').innerText = 'Invite link: https://share.autopush.in/#' + room;
        $('attendeeStatus').innerText = 'Waiting for attendee to join...';
      }
      else
        $('attendeeinfo').classList.remove('hidden');
        $('meeting-room-attendee').innerText = 'Meeting room:' + location.hash.substring(1).replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
    function showLandingpageUI() {
      $('landing').classList.remove('hidden');
      $('hero').classList.remove('hidden');
      if (peer === 'pc1')
        $('presenterinfo').classList.add('hidden');
      else
        $('attendeeinfo').classList.add('hidden');
    }

    async function initBroadcasting() {
      pc1 = new RTCPeerConnection(iceServers);
      pc1.addEventListener('icecandidate', e => onIceCandidate(e, 'pc1'));
      stream.getTracks().forEach(track => pc1.addTrack(track, stream));
      try {
        const offer = await pc1.createOffer(offerOptions);
        await pc1.setLocalDescription(offer);
        await channel.publish('readyToBroadcast', { content: offer });
      } catch (e) {
        console.error('Offer failed:', e);
      }
    }

    async function initReceiving(msg) {
      pc2 = new RTCPeerConnection(iceServers);
      pc2.addEventListener('icecandidate', e => onIceCandidate(e, 'pc2'));
      pc2.addEventListener('track', gotRemoteStream);
      try {
        await pc2.setRemoteDescription(msg.data.content);
        const answer = await pc2.createAnswer();
        await pc2.setLocalDescription(answer);
        await channel.publish('readyToReceive', { content: answer });
      } catch (e) {
        console.error('Receiving failed:', e);
      }
    }

    function gotRemoteStream(e) {
      const remoteStream = e.streams[e.streams.length-1];
      if (localVideo.srcObject !== remoteStream) {
        localVideo.srcObject = remoteStream;
        localVideo.play();
      }
    }

    async function startBroadcasting(msg) {
      try {
        await pc1.setRemoteDescription(msg.data.content);
        $('attendeeStatus').innerText = 'An attendee has joined the session';
      } catch (e) {
        console.error('Remote set failed:', e);
      }
    }

    async function onIceCandidate({ candidate }, type) {
      if (!candidate) return;
      await channel.publish('ice', { type, candidate: JSON.stringify(candidate) });
    }

    channel.subscribe('ice', (msg) => {
      const data = msg.data;
      if (data.type === peer) return;
      const candidate = JSON.parse(data.candidate);
      if (data.type === 'pc1') pc2.addIceCandidate(candidate);
      else if (data.type === 'pc2') pc1.addIceCandidate(candidate);
    });

    function hangup() {
      [pc1, pc2].forEach(pc => pc && pc.close());
      if (stream) stream.getTracks().forEach(track => track.stop());
      localVideo.srcObject = null;
      localVideo.removeAttribute('poster');
      //ably.close();
      showLandingpageUI();
    }
    window.addEventListener("beforeunload", hangup);
  </script>
</body>
</html>
